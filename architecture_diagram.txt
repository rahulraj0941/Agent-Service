# Medical Appointment Scheduling Agent - System Architecture

┌─────────────────────────────────────────────────────────────────────────┐
│                        USER INTERFACE (React Frontend)                   │
│                                                                           │
│  ┌──────────────────────┐         ┌────────────────────────────┐       │
│  │  ChatInterface.jsx   │         │  App.jsx                   │       │
│  │  - Message Display   │────────▶│  - Application Container   │       │
│  │  - User Input        │         │  - Header & Layout         │       │
│  │  - Typing Indicators │         └────────────────────────────┘       │
│  │  - Real-time Updates │                                               │
│  └──────────────────────┘                                               │
└────────────────┬────────────────────────────────────────────────────────┘
                 │
                 │ HTTP (POST /api/chat)
                 │
┌────────────────▼────────────────────────────────────────────────────────┐
│                      FASTAPI BACKEND SERVER (Port 8000)                  │
│                                                                           │
│  ┌──────────────────────┐         ┌────────────────────────────┐       │
│  │  Chat Endpoint       │         │  Calendly API (Mock)       │       │
│  │  /api/chat           │         │  /api/calendly/availability│       │
│  │  /api/health         │         │  /api/calendly/book        │       │
│  └──────────┬───────────┘         └────────────────────────────┘       │
│             │                                                             │
│             ▼                                                             │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │              SCHEDULING AGENT (LangChain + OpenAI)           │       │
│  │                                                               │       │
│  │  ┌────────────────────────────────────────────────────┐     │       │
│  │  │  Conversation Management                           │     │       │
│  │  │  - Multi-turn dialogue                            │     │       │
│  │  │  - Context awareness                              │     │       │
│  │  │  - Seamless context switching (FAQ ↔ Scheduling)│     │       │
│  │  └────────────────────────────────────────────────────┘     │       │
│  │                                                               │       │
│  │  ┌────────────────────┐      ┌───────────────────────┐     │       │
│  │  │  Tool: Availability│      │  Tool: Book           │     │       │
│  │  │  - Check slots     │      │  - Create appointment │     │       │
│  │  │  - Filter by type  │      │  - Validate data      │     │       │
│  │  │  - Return options  │      │  - Generate conf code │     │       │
│  │  └────────────────────┘      └───────────────────────┘     │       │
│  └───────────────────┬──────────────────────────────────────────       │
│                      │                                                   │
│                      ▼                                                   │
│  ┌──────────────────────────────────────────────────────────────┐       │
│  │              RAG SYSTEM (FAQ Knowledge Base)                 │       │
│  │                                                               │       │
│  │  ┌────────────────┐  ┌──────────────┐  ┌─────────────────┐ │       │
│  │  │   Embeddings   │  │ Vector Store │  │  Clinic Info    │ │       │
│  │  │  (OpenAI       │  │  (ChromaDB)  │  │  (JSON Data)    │ │       │
│  │  │   text-embed-  │  │              │  │  - Insurance    │ │       │
│  │  │   3-small)     │  │  Semantic    │  │  - Policies     │ │       │
│  │  │                │─▶│  Search      │◀─│  - Hours        │ │       │
│  │  │  Query → Vec   │  │              │  │  - Preparation  │ │       │
│  │  └────────────────┘  └──────────────┘  └─────────────────┘ │       │
│  │                                                               │       │
│  │  Flow: User Query → Embedding → Vector Search → Top 3 Docs  │       │
│  └──────────────────────────────────────────────────────────────┘       │
└───────────────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────────────┐
│                      DATA STORAGE & PERSISTENCE                           │
│                                                                           │
│  ┌────────────────────┐  ┌──────────────────┐  ┌─────────────────────┐ │
│  │  clinic_info.json  │  │ doctor_schedule  │  │  appointments.json   │ │
│  │  - FAQ data        │  │ - Working hours  │  │  - New bookings      │ │
│  │  - Policies        │  │ - Blocked dates  │  │  - Confirmations     │ │
│  │  - Insurance       │  │ - Pre-booked     │  │  - Patient info      │ │
│  └────────────────────┘  └──────────────────┘  └─────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────┘


CONVERSATION FLOW:
══════════════════

1. GREETING PHASE
   User: "I need to see the doctor"
   Agent: Greets warmly, asks reason for visit

2. UNDERSTANDING PHASE
   User: Describes symptoms/reason
   Agent: Recommends appointment type (30/15/45/60 min)

3. PREFERENCE GATHERING
   Agent: Asks about date/time preferences
   User: Provides preferences (morning/afternoon, this week, etc.)

4. SLOT RECOMMENDATION
   Agent: Uses check_availability tool
   Response: Shows 3-5 available time slots
   User: Selects preferred slot

5. INFORMATION COLLECTION
   Agent: Collects name, phone, email, reason
   User: Provides information step-by-step

6. CONFIRMATION
   Agent: Summarizes all details
   User: Confirms booking

7. BOOKING
   Agent: Uses book_appointment tool
   Response: Confirmation code + booking ID
   Agent: Provides confirmation details


CONTEXT SWITCHING EXAMPLE:
═════════════════════════

Scenario: FAQ During Booking Flow

User: "I want to book an appointment"
Agent: "I'd be happy to help! What brings you in?"

User: "What insurance do you accept?"
├─▶ Agent detects FAQ keyword "insurance"
├─▶ Retrieves from RAG/JSON fallback
└─▶ Agent: "We accept Blue Cross, Aetna, Cigna..."

User: "Great, I have Blue Cross. Let's book a checkup"
├─▶ Agent remembers booking context
└─▶ Agent: "Perfect! For your checkup, would this be your first visit?"

[Continues with scheduling flow]


SCHEDULING LOGIC:
═════════════════

Available Slot Determination:
1. Check if date is within working hours (Mon-Sat)
2. Exclude blocked dates (holidays)
3. Exclude lunch break (12:00-13:00)
4. Match appointment duration to type:
   - consultation: 30 min
   - followup: 15 min
   - physical: 45 min
   - specialist: 60 min
5. Generate 15-minute interval slots
6. Check against existing bookings
7. Return only available slots

Conflict Prevention:
- Compare requested slot with all bookings
- Check for time overlap
- Reject if any conflict exists
- Prevents double-booking


EDGE CASE HANDLING:
═══════════════════

1. No Available Slots
   → Explain clearly
   → Suggest alternative dates
   → Mention calling office for urgent needs

2. Ambiguous Time
   "Tomorrow morning" → Ask for specific time
   "Around 3" → Confirm AM/PM

3. Past Dates
   → Politely redirect to future dates

4. API Failures
   → Graceful error messages
   → Fallback to phone contact

5. User Changes Mind
   → Handle gracefully
   → Allow restart without confusion
